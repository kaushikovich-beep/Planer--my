<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>üéÑ Neon Planner Pro</title>
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f0c29">
    
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/3523/3523887.png">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3523/3523887.png">

    <link rel="manifest" href="data:application/manifest+json,{%22name%22:%22Neon%20Planner%22,%22short_name%22:%22Neon%22,%22start_url%22:%22.%22,%22display%22:%22standalone%22,%22background_color%22:%22#0f0c29%22,%22theme_color%22:%22#ffd700%22,%22icons%22:[{%22src%22:%22https://cdn-icons-png.flaticon.com/512/3523/3523887.png%22,%22sizes%22:%22512x512%22,%22type%22:%22image/png%22}]}">

    <style>
        :root { 
            --gold: #ffd700; --green: #32cd32; --red: #c41e3a; 
            --bg: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            --card-bg: rgba(255, 255, 255, 0.07); --text: #fff;
        }
        
        body.light-theme {
            --bg: linear-gradient(135deg, #e0eafc, #cfdef3);
            --card-bg: rgba(0, 0, 0, 0.05); --text: #24243e;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: var(--bg); color: var(--text);
            margin: 0; padding: 15px; min-height: 100vh; transition: all 0.3s ease;
            -webkit-tap-highlight-color: transparent;
            user-select: none; /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Å–ª—É—á–∞–π–Ω–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –ø—Ä–∏ —Ç–∞–ø–∞—Ö */
        }

        .tinsel {
            position: fixed; top: -10px; left: 0; width: 100%; font-size: 30px; 
            color: rgba(255, 215, 0, 0.4); z-index: 100; pointer-events: none; white-space: nowrap;
        }

        .container { max-width: 800px; margin: 40px auto; position: relative; }

        .top-bar { display: flex; justify-content: space-between; margin-bottom: 15px; }
        .icon-btn { 
            background: var(--card-bg); border: 1px solid var(--gold); border-radius: 50%; 
            width: 45px; height: 45px; cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center;
        }

        .tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
        .tab-btn {
            padding: 12px 20px; border-radius: 20px; border: 1px solid var(--gold);
            background: var(--card-bg); color: var(--text); font-weight: bold; cursor: pointer;
        }
        .tab-btn.active { background: var(--gold); color: #000; box-shadow: 0 0 15px var(--gold); }

        .section { display: none; }
        .section.active { display: block; }

        .header-profile {
            display: flex; justify-content: center; align-items: center; gap: 30px;
            margin-bottom: 20px; padding: 20px; background: var(--card-bg);
            border-radius: 20px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2);
        }
        .tree-img { max-width: 80px; filter: drop-shadow(0 0 10px var(--green)); }
        .avatar-container { position: relative; width: 100px; height: 100px; cursor: pointer; }
        #user-photo { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 3px solid var(--gold); }

        #list-container {
            border: 2px solid var(--green); border-radius: 12px; padding: 10px;
            background: rgba(0, 0, 0, 0.2); max-height: 40vh; overflow-y: auto;
        }
        .item-row { display: flex; background: var(--card-bg); margin-bottom: 10px; border-radius: 10px; overflow-x: auto; scrollbar-width: none; }
        .row-content { display: flex; align-items: center; min-width: 100%; padding: 8px; gap: 8px; }
        
        .item-row textarea { 
            flex: 2; min-width: 180px; min-height: 38px; border-radius: 8px; padding: 8px; 
            font-size: 15px; border: none; resize: none; background: transparent; color: inherit;
            user-select: text;
        }
        .price-input { width: 65px; flex-shrink: 0; padding: 8px 4px; border-radius: 8px; border: none; font-weight: bold; text-align: center; background: rgba(255,255,255,0.1); color: inherit; user-select: text; }
        .del-btn { background: var(--red); color: white; border: none; border-radius: 8px; padding: 8px 12px; font-weight: bold; flex-shrink: 0; }

        .item-row.is-checked { background: rgba(50, 205, 50, 0.2); }
        .shopping-mode-active .item-row.is-checked { display: none; }

        #totals-container {
            margin-top: 15px; padding: 15px; background: rgba(0, 0, 0, 0.4);
            border-radius: 15px; border: 2px dashed var(--gold); text-align: right;
        }

        .cards-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; padding: 10px; }
        .card-item {
            position: relative; aspect-ratio: 3/2; background: var(--card-bg);
            border: 2px dashed var(--gold); border-radius: 12px; display: flex; align-items: center; justify-content: center; overflow: hidden;
        }
        .card-item img { width: 100%; height: 100%; object-fit: cover; }
        .card-controls { position: absolute; top: 5px; right: 5px; display: flex; gap: 5px; }
        .mini-btn { width: 28px; height: 28px; border-radius: 50%; border: none; color: white; font-weight: bold; font-size: 14px; }

        #viewer {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 1000; justify-content: center; align-items: center;
        }
        #viewer img { max-width: 100%; max-height: 100%; }

        .backup-zone { display: flex; justify-content: center; gap: 10px; margin-top: 20px; padding-bottom: 20px; }
        .small-btn { font-size: 11px; padding: 8px 12px; border-radius: 8px; border: 1px solid var(--gold); background: var(--card-bg); color: var(--text); }

        #add-button, #add-card-btn {
            display: block; width: 100%; max-width: 300px; margin: 20px auto;
            padding: 16px; background: linear-gradient(var(--green), #1e5d3a);
            color: white; border: none; border-radius: 15px; font-size: 1.1em; font-weight: bold;
        }
    </style>
</head>
<body class="dark-theme">

<div class="tinsel">||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||</div>

<div class="container" id="main-app">
    <div class="top-bar">
        <button class="icon-btn" onclick="toggleTheme()">üåó</button>
        <button class="icon-btn" id="shop-mode-btn" onclick="toggleShoppingMode()">‚ö°</button>
    </div>

    <div class="header-profile">
        <img src="https://cdn-icons-png.flaticon.com/512/632/632605.png" class="tree-img">
        <div class="avatar-container" onclick="document.getElementById('file-input').click()">
            <img id="user-photo" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=">
        </div>
        <input type="file" id="file-input" style="display:none" accept="image/*" onchange="processImage(this, 'profile')">
    </div>

    <div class="tabs">
        <button class="tab-btn active" id="tab-list" onclick="switchTab('planner')">üìù –°–ø–∏—Å–æ–∫</button>
        <button class="tab-btn" id="tab-cards" onclick="switchTab('cards')">üí≥ –ö–∞—Ä—Ç—ã</button>
    </div>

    <div id="planner" class="section active">
        <div id="list-container"></div>
        <div id="totals-container">
            <div>üí∞ –ò—Ç–æ–≥–æ: <strong><span id="total-sum">0.00</span> ‚ÇΩ</strong></div>
            <div style="color:var(--green)">üéÅ –ö—É–ø–ª–µ–Ω–æ: <strong><span id="paid-sum">0.00</span> ‚ÇΩ</strong></div>
        </div>
        <button id="add-button">‚ùÑÔ∏è –î–æ–±–∞–≤–∏—Ç—å –ø–æ–∫—É–ø–∫—É</button>
    </div>

    <div id="cards" class="section">
        <div class="cards-grid" id="cards-grid"></div>
        <button id="add-card-btn">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ä—Ç—É</button>
    </div>

    <div class="backup-zone">
        <button class="small-btn" onclick="exportBackup()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –±—ç–∫–∞–ø</button>
        <button class="small-btn" onclick="document.getElementById('import-file').click()">üìÇ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
        <input type="file" id="import-file" style="display:none" accept=".json" onchange="importBackup(this)">
    </div>
</div>

<div id="viewer" onclick="closeViewer()">
    <img id="viewer-img" src="">
</div>

<input type="file" id="card-upload" style="display:none" accept="image/*" onchange="processImage(this, 'card')">

<script>
    let isShoppingMode = false;
    let wakeLock = null;
    let currentSlot = null;

    function processImage(input, type) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    let width = img.width, height = img.height;
                    const MAX_WIDTH = 800;
                    if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    const compressed = canvas.toDataURL('image/jpeg', 0.6);
                    if (type === 'profile') {
                        document.getElementById('user-photo').src = compressed;
                        localStorage.setItem('neon-profile-v7', compressed);
                    } else { renderCardSlot(currentSlot, compressed); saveCards(); }
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function toggleTheme() {
        document.body.classList.toggle('light-theme');
        localStorage.setItem('neon-theme', document.body.classList.contains('light-theme'));
    }

    async function toggleShoppingMode() {
        isShoppingMode = !isShoppingMode;
        document.getElementById('main-app').classList.toggle('shopping-mode-active');
        document.getElementById('shop-mode-btn').style.boxShadow = isShoppingMode ? "0 0 15px var(--gold)" : "none";
        if (isShoppingMode && 'wakeLock' in navigator) {
            try { wakeLock = await navigator.wakeLock.request('screen'); } catch(e){}
        } else if (wakeLock) { wakeLock.release(); wakeLock = null; }
    }

    function switchTab(tabId) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        document.getElementById('tab-' + (tabId === 'planner' ? 'list' : 'cards')).classList.add('active');
    }

    function saveItems() {
        const items = [];
        document.querySelectorAll('.item-row').forEach(row => {
            items.push({ text: row.querySelector('textarea').value, checked: row.querySelector('input[type="checkbox"]').checked, price: row.querySelector('.price-input').value });
        });
        localStorage.setItem('neon-data-v7', JSON.stringify(items));
        updateTotals();
    }

    function updateTotals() {
        let total = 0, paid = 0;
        document.querySelectorAll('.item-row').forEach(row => {
            const price = parseFloat(row.querySelector('.price-input').value) || 0;
            const isChecked = row.querySelector('input[type="checkbox"]').checked;
            row.classList.toggle('is-checked', isChecked);
            total += price; if (isChecked) paid += price;
        });
        document.getElementById('total-sum').textContent = total.toFixed(2);
        document.getElementById('paid-sum').textContent = paid.toFixed(2);
    }

    function addItem(text = '', checked = false, price = '') {
        const row = document.createElement('div');
        row.className = 'item-row';
        row.innerHTML = `<div class="row-content"><input type="checkbox" ${checked ? 'checked' : ''} onchange="saveItems()"><textarea placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ..." oninput="saveItems()">${text}</textarea><input type="number" class="price-input" placeholder="0" value="${price}" oninput="saveItems()"><button class="del-btn" onclick="this.closest('.item-row').remove();saveItems()">‚úï</button></div>`;
        document.getElementById('list-container').appendChild(row);
        if(checked) row.classList.add('is-checked');
    }

    function saveCards() {
        const cards = [];
        document.querySelectorAll('.card-item img').forEach(img => cards.push(img.src));
        localStorage.setItem('neon-cards-v7', JSON.stringify(cards));
    }

    function renderCardSlot(slot, imgSrc = null) {
        if (imgSrc) {
            slot.innerHTML = `<img src="${imgSrc}"><div class="card-controls"><button class="mini-btn" style="background:var(--gold);color:#000" onclick="event.stopPropagation(); currentSlot=this.closest('.card-item'); document.getElementById('card-upload').click()">‚úé</button><button class="mini-btn" style="background:var(--red)" onclick="event.stopPropagation(); this.closest('.card-item').remove(); saveCards();">‚úï</button></div>`;
        } else {
            slot.innerHTML = `<span style="font-size:10px;color:var(--gold);text-align:center">–î–û–ë–ê–í–ò–¢–¨<br>–ö–ê–†–¢–£</span>`;
        }
    }

    function addCardSlot(imgSrc = null) {
        const slot = document.createElement('div');
        slot.className = 'card-item';
        renderCardSlot(slot, imgSrc);
        slot.onclick = () => {
            const img = slot.querySelector('img');
            if (img) {
                document.getElementById('viewer-img').src = img.src;
                document.getElementById('viewer').style.display = 'flex';
                history.pushState({viewingCard: true}, "");
            } else { currentSlot = slot; document.getElementById('card-upload').click(); }
        };
        document.getElementById('cards-grid').appendChild(slot);
    }

    function closeViewer() { document.getElementById('viewer').style.display = 'none'; if (history.state?.viewingCard) history.back(); }
    window.onpopstate = () => { document.getElementById('viewer').style.display = 'none'; };

    function exportBackup() {
        const data = { profile: localStorage.getItem('neon-profile-v7'), items: localStorage.getItem('neon-data-v7'), cards: localStorage.getItem('neon-cards-v7'), theme: localStorage.getItem('neon-theme') };
        const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `neon_planner_backup.json`;
        a.click();
    }

    function importBackup(input) {
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);
                localStorage.setItem('neon-profile-v7', data.profile || "");
                localStorage.setItem('neon-data-v7', data.items || "[]");
                localStorage.setItem('neon-cards-v7', data.cards || "[]");
                localStorage.setItem('neon-theme', data.theme || "false");
                loadAppData(); 
                alert("–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã!");
            } catch(err) { alert("–û—à–∏–±–∫–∞ —Ñ–∞–π–ª–∞ –±—ç–∫–∞–ø–∞!"); }
        };
        reader.readAsText(input.files[0]);
    }

    function loadAppData() {
        document.getElementById('list-container').innerHTML = "";
        document.getElementById('cards-grid').innerHTML = "";
        if (localStorage.getItem('neon-theme') === 'true') document.body.classList.add('light-theme');
        else document.body.classList.remove('light-theme');
        const savedPhoto = localStorage.getItem('neon-profile-v7');
        document.getElementById('user-photo').src = savedPhoto || "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=";
        const savedData = localStorage.getItem('neon-data-v7');
        if (savedData && savedData !== "[]") JSON.parse(savedData).forEach(i => addItem(i.text, i.checked, i.price)); 
        else addItem();
        const savedCards = localStorage.getItem('neon-cards-v7');
        if (savedCards && savedCards !== "[]") JSON.parse(savedCards).forEach(src => addCardSlot(src)); 
        else addCardSlot();
        updateTotals();
    }

    window.onload = loadAppData;
    document.getElementById('add-button').onclick = () => { addItem(); saveItems(); };
    document.getElementById('add-card-btn').onclick = () => addCardSlot();
</script>
</body>
</html>
